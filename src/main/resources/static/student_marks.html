<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Student Marks ‚Äî Dashboard</title>
    <style>
        :root{
          --bg:#f4f7fb;
          --card:#ffffff;
          --accent:#1976d2;
          --muted:#6b7280;
          --glass: rgba(25,118,210,0.06);
          --success:#16a34a;
          --danger:#dc2626;
          --radius:10px;
        }
        *{box-sizing:border-box}
        body{
          margin:0;
          font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
          background:var(--bg);
          color:#0f172a;
          -webkit-font-smoothing:antialiased;
        }

        /* Topbar */
        .topbar{
          height:64px;
          display:flex;
          align-items:center;
          justify-content:space-between;
          padding:10px 20px;
          background:linear-gradient(90deg,var(--card),transparent);
          border-bottom:1px solid rgba(15,23,42,0.04);
        }
        .brand{display:flex;align-items:center;gap:12px}
        .logo{
          width:44px;height:44px;border-radius:8px;background:var(--accent);
          display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:0 3px 10px rgba(25,118,210,0.15)
        }
        .title{font-size:18px;font-weight:600}
        .top-actions{display:flex;align-items:center;gap:12px}

        /* Layout */
        .layout{
          display:flex;
          gap:18px;
          padding:20px;
          max-width:1100px;
          margin:18px auto;
        }

        /* Sidebar / burger */
        .sidebar{
          width:260px;
          min-height:520px;
        }
        .card{
          background:var(--card);
          border-radius:var(--radius);
          padding:16px;
          box-shadow:0 6px 20px rgba(11,20,40,0.06);
        }
        .burger{
          display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px;border-radius:8px;
        }
        .burger:hover{background:var(--glass)}
        .hamburger-icon{font-size:20px; color:var(--accent)}
        .semester-list{margin-top:12px; display:flex;flex-direction:column; gap:8px}
        .sem-item{
          padding:10px 12px;border-radius:8px;cursor:pointer;border:1px solid rgba(11,20,40,0.04);
          display:flex;justify-content:space-between;align-items:center;
        }
        .sem-item:hover{background:var(--glass)}
        .sem-item.active{background:linear-gradient(90deg, rgba(25,118,210,0.06), transparent);border-color:rgba(25,118,210,0.12)}

        /* Main content */
        .main{
          flex:1;
        }
        .panel{
          background:var(--card);
          border-radius:var(--radius);
          padding:18px;
          box-shadow:0 6px 20px rgba(11,20,40,0.06);
        }
        h2{margin:0 0 12px 0;font-size:20px}
        .subhead{color:var(--muted);font-size:13px;margin-bottom:16px}

        /* Table */
        table{width:100%;border-collapse:collapse;margin-top:8px}
        th,td{padding:10px 8px;border:1px solid rgba(15,23,42,0.06);text-align:center;font-size:14px}
        th{background:#f8fafc;color:#334155;font-weight:600}
        input[type="number"], input[type="text"]{
          width:100%; padding:8px;border-radius:6px;border:1px solid #e6eef9;background:transparent;text-align:center;
        }
        input[readonly]{
          background:transparent;border:0;color:#111827;
        }

        .actions{display:flex;gap:10px;margin-top:14px}
        .btn{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
        .btn.primary{background:var(--accent);color:white}
        .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06)}
        .msg{padding:10px;border-radius:8px;margin-top:12px}

        /* Locked look */
        .locked{
          filter:grayscale(0.3);
          opacity:0.9;
          position:relative;
        }
        .locked::after{
          content:"üîí Locked by Mentor";
          position:absolute;
          top:10px;right:12px;background:rgba(0,0,0,0.04);padding:6px 10px;border-radius:8px;font-size:13px;
        }

        /* responsive */
        @media(max-width:880px){
          .layout{flex-direction:column;padding:12px}
          .sidebar{width:100%}
        }

        /* small helper */
        .muted{color:var(--muted);font-size:13px}
    </style>
</head>
<body>
<div class="topbar">
    <div class="brand">
        <div class="logo">ST</div>
        <div>
            <div class="title">Student Portal</div>
            <div class="muted" style="font-size:12px">Marks & Academics</div>
        </div>
    </div>
    <div class="top-actions">
        <div class="muted">Welcome, Student</div>
        <button class="btn ghost" onclick="goToDashboard()">‚¨Ö Dashboard</button>
    </div>
</div>

<div class="layout">
    <aside class="sidebar">
        <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between">
                <div>
                    <div style="font-weight:700">Semester Selector</div>
                    <div class="muted" style="font-size:12px">Choose a semester to view/edit marks</div>
                </div>
                <div class="burger" onclick="toggleSemList()" title="Open semesters">
                    <div class="hamburger-icon">‚ò∞</div>
                </div>
            </div>

            <div id="semList" class="semester-list" style="display:none; margin-top:14px;">
                <!-- JS will populate -->
            </div>

            <div style="margin-top:14px; display:flex;gap:10px">
                <button class="btn ghost" onclick="loadLast()">Reload</button>
                <button class="btn" onclick="saveAll()" id="saveAllBtn" style="background:#0ea5e9;color:white">Save (current sem)</button>
            </div>

        </div>
    </aside>

    <main class="main">
        <div class="panel">
            <h2 id="panelTitle">Select a semester</h2>
            <div class="subhead" id="panelSub">Use the sidebar to choose which semester to open.</div>

            <div id="tableWrapper" style="display:none">
                <div id="lockNote" class="muted" style="margin-bottom:6px"></div>

                <div id="marksPanel" class="">
                    <table id="marksTable">
                        <!-- Head & body built by JS -->
                    </table>

                    <div class="actions">
                        <button class="btn primary" onclick="saveMarks()">Save</button>
                        <button class="btn ghost" onclick="resetTable()">Reset</button>
                    </div>

                    <div id="feedback" style="margin-top:12px"></div>
                </div>
            </div>
        </div>

        <div style="height:14px"></div>

        <div class="panel" id="historyPanel" style="display:none;margin-top:18px">
            <h3 style="margin:0 0 8px 0">Previous Submissions / Status</h3>
            <div class="muted" id="historyText">No submissions yet.</div>
        </div>
    </main>
</div>

<script>
    /* ============================
       Hardcoded data + lock state
       ============================ */
    const semSubjects = {
      1: ["Mathematics I","Physics","Basic Electronics","English"],
      2: ["Mathematics II","Chemistry","C Programming","Environmental Studies"],
      3: ["OOP","DBMS","DC","System Design"],
      4: ["Operating Systems","Microprocessors","Software Engineering","Computer Networks"],
      5: ["Web Technologies","Theory of Computation","Data Mining","Design & Analysis"],
      6: ["Machine Learning","Distributed Systems","Compiler Design","Cloud Computing"],
      7: ["Advanced Algorithms","Elective I","Elective II","Project Phase I"],
      8: ["Project Phase II","Internship","Elective III","Seminar"]
    };

    // hardcoded lock state (for now)
    const semLocked = { 3: true };

    let currentSem = null;
    let currentMarks = {}; // holds table state for current sem

    /* Build semester list on startup */
    function toggleSemList(){
      const el = document.getElementById('semList');
      el.style.display = (el.style.display === 'none' ? 'flex' : 'none');
    }
    function buildSemList(){
      const list = document.getElementById('semList');
      list.innerHTML = '';
      for(let s=1;s<=8;s++){
        const item = document.createElement('div');
        item.className = 'sem-item';
        item.id = 'sem-item-' + s;
        item.innerHTML = `<div>Semester ${s}</div><div class="muted">${semLocked[s] ? 'üîí' : '‚úèÔ∏è'}</div>`;
        item.onclick = ()=>openSemester(s);
        list.appendChild(item);
      }
    }
    buildSemList();

    /* Open a semester */
    function openSemester(sem){
      currentSem = sem;
      // UI highlights
      document.querySelectorAll('.sem-item').forEach(x=>x.classList.remove('active'));
      const el = document.getElementById('sem-item-' + sem);
      if(el) el.classList.add('active');

      // set title and show table area
      document.getElementById('panelTitle').textContent = `Semester ${sem} Marks`;
      document.getElementById('panelSub').textContent = `Fill or view marks for Semester ${sem}`;
      document.getElementById('tableWrapper').style.display = 'block';
      document.getElementById('historyPanel').style.display = 'block';
      document.getElementById('feedback').innerHTML = '';

      // render table
      renderMarksTable(sem);
      // auto-load from backend (if exists)
      loadMarksFromServer(sem);
    }

    /* Render table HTML for a semester */
    function renderMarksTable(sem){
      const subjects = semSubjects[sem] || [];
      const table = document.getElementById('marksTable');
      table.innerHTML = '';
      // header
      table.innerHTML += `
        <thead>
          <tr>
            <th>Subject</th>
            <th>MSE1</th>
            <th>MSE2</th>
            <th>Task Total</th>
            <th>SEE Marks</th>
            <th>Total Marks</th>
            <th>Grade</th>
          </tr>
        </thead>
        <tbody id="marksTbody"></tbody>
      `;
      const tbody = document.getElementById('marksTbody');
      subjects.forEach((sub, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="text-align:left;padding-left:12px">${sub}</td>
          <td><input type="number" min="0" max="100" class="mse1" data-idx="${idx}"></td>
          <td><input type="number" min="0" max="100" class="mse2" data-idx="${idx}"></td>
          <td><input type="number" min="0" max="100" class="task" data-idx="${idx}"></td>
          <td><input type="number" min="0" max="100" class="see" data-idx="${idx}"></td>
          <td><input type="text" readonly class="total" data-idx="${idx}"></td>
          <td><input type="text" readonly class="grade" data-idx="${idx}"></td>
        `;
        tbody.appendChild(row);
      });

      // attach listeners for calculations
      Array.from(document.querySelectorAll('#marksTable input[type="number"]')).forEach(inp=>{
        inp.addEventListener('input', recalcRow);
      });

      // handle lock styling
      applyLockState(sem);
    }

    /* Recalculate totals & grade for a changed row */
    function recalcRow(e){
      const idx = e.target.dataset.idx;
      const row = e.target.closest('tr');
      const mse1 = parseFloat(row.querySelector('.mse1').value) || 0;
      const mse2 = parseFloat(row.querySelector('.mse2').value) || 0;
      const task = parseFloat(row.querySelector('.task').value) || 0;
      const see = parseFloat(row.querySelector('.see').value) || 0;
      // basic total logic: sum of all (customize later to your rules)
      const total = mse1 + mse2 + task + see;
      row.querySelector('.total').value = total.toFixed(1);
      row.querySelector('.grade').value = computeGrade(total);
    }

    /* simple grade mapping (customize easily) */
    function computeGrade(total){
      // assuming max theoretical ~400, we'll use percentage logic
      const perc = total;
      if(perc >= 90) return 'S';
      if(perc >= 80) return 'A';
      if(perc >= 70) return 'B';
      if(perc >= 60) return 'C';
      if(perc >= 50) return 'D';
      return 'F';
    }

    /* Apply lock (gray out + disable inputs) */
    function applyLockState(sem){
      const locked = !!semLocked[sem];
      const marksPanel = document.getElementById('marksPanel');
      const inputs = marksPanel.querySelectorAll('input');
      if(locked){
        // set inputs readonly and style locked
        inputs.forEach(i => {
          i.setAttribute('readonly','true');
          i.style.border='0';
          i.style.background='transparent';
        });
        marksPanel.classList.add('locked');
        document.getElementById('lockNote').textContent = 'This semester is locked by your mentor. You can view the submitted values but cannot edit them.';
        // hide Save button if locked
        document.querySelector('.btn.primary').style.display = 'none';
      } else {
        inputs.forEach(i => {
          i.removeAttribute('readonly');
          i.style.border='';
          i.style.background='';
        });
        marksPanel.classList.remove('locked');
        document.getElementById('lockNote').textContent = '';
        document.querySelector('.btn.primary').style.display = 'inline-block';
      }
    }

    /* Load marks from server for sem (GET /api/marks?sem=X)
       If backend returns 404/empty, we keep blanks.
       Expected response shape (example):
       { semester:3, subjects: [{ name:"OOP", mse1:12, mse2:13, task:10, see:45, total:80, grade:"A"}, ...] }
    */
    async function loadMarksFromServer(sem){
      // show loading
      document.getElementById('historyText').textContent = 'Loading...';
      try{
        const res = await fetch(`/api/marks?sem=${sem}`);
        if(!res.ok){
          // no data or error ‚Äî keep blanks
          document.getElementById('historyText').textContent = 'No saved submission found for this semester.';
          // still apply lock state (hardcoded or backend later)
          applyLockState(sem);
          return;
        }
        const data = await res.json();
        if(Array.isArray(data.subjects) && data.subjects.length){
          populateTableWithData(data.subjects);
          document.getElementById('historyText').textContent = `Data fetched from server. ${data.subjects.length} subjects loaded.`;
        } else {
          document.getElementById('historyText').textContent = 'No saved submission found for this semester.';
        }
      } catch(err){
        console.warn('load error', err);
        document.getElementById('historyText').textContent = 'Unable to fetch data (network error).';
      } finally {
        applyLockState(sem);
      }
    }

    /* Fill fields with server data */
    function populateTableWithData(subjects){
      const tbody = document.getElementById('marksTbody');
      const rows = tbody.querySelectorAll('tr');
      subjects.forEach((s, idx)=>{
        const row = rows[idx];
        if(!row) return;
        row.querySelector('.mse1').value = s.mse1 ?? '';
        row.querySelector('.mse2').value = s.mse2 ?? '';
        row.querySelector('.task').value = s.task ?? '';
        row.querySelector('.see').value = s.see ?? '';
        row.querySelector('.total').value = s.total ?? '';
        row.querySelector('.grade').value = s.grade ?? '';
      });
    }

    /* Save current table to server (single POST /api/marks?sem=X) */
    async function saveMarks(){
      if(!currentSem){ alert('Select a semester first'); return; }
      if(semLocked[currentSem]){ alert('This semester is locked and cannot be edited'); return; }

      const subjects = semSubjects[currentSem];
      const tbody = document.getElementById('marksTbody');
      const rows = tbody.querySelectorAll('tr');
      const payload = { semester: currentSem, subjects: [] };

      rows.forEach((row, idx) => {
        const name = subjects[idx] || row.cells[0].innerText.trim();
        const mse1 = parseFloat(row.querySelector('.mse1').value) || 0;
        const mse2 = parseFloat(row.querySelector('.mse2').value) || 0;
        const task = parseFloat(row.querySelector('.task').value) || 0;
        const see  = parseFloat(row.querySelector('.see').value) || 0;
        const total = parseFloat(row.querySelector('.total').value) || (mse1+mse2+task+see);
        const grade = row.querySelector('.grade').value || computeGrade(total);
        payload.subjects.push({ name, mse1, mse2, task, see, total, grade });
      });

      // UI feedback
      const fb = document.getElementById('feedback');
      fb.innerHTML = `<div class="msg" style="background:var(--glass)">Saving...</div>`;

      try{
        const res = await fetch(`/api/marks?sem=${currentSem}`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(res.ok){
          fb.innerHTML = `<div class="msg" style="background:lavenderblush;color:var(--success)">Saved successfully.</div>`;
          // optionally notify mentor via server
          // reload saved state
          loadMarksFromServer(currentSem);
        } else {
          const text = await res.text();
          fb.innerHTML = `<div class="msg" style="background:#fff4f4;color:var(--danger)">Save failed: ${text}</div>`;
        }
      } catch(err){
        fb.innerHTML = `<div class="msg" style="background:#fff4f4;color:var(--danger)">Network error while saving.</div>`;
      }
    }

    /* SaveAll is same as saveMarks (keeps sidebar button) */
    function saveAll(){ saveMarks(); }

    /* reset table to blanks or last-saved values */
    function resetTable(){
      if(!currentSem) return;
      if(confirm('Reset current inputs to last saved state?')) loadMarksFromServer(currentSem);
    }

    /* go to dashboard placeholder */
    function goToDashboard(){ window.location = 'student_dashboard.html'; }

    /* Load last selection or default sem 3 */
    function loadLast(){
      const defaultSem = 3;
      openSemester(defaultSem);
    }
</script>
</body>
</html>
