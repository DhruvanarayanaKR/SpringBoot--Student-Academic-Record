<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login | Student Portal</title>
    <style>
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #74ebd5 0%, #9face6 100%);
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          margin: 0;
        }

        .login-box {
          background: #fff;
          padding: 40px 35px;
          border-radius: 16px;
          box-shadow: 0px 10px 25px rgba(0,0,0,0.2);
          width: 380px;
          text-align: center;
          animation: fadeIn 0.6s ease-in-out;
        }

        .login-box h2 {
          margin-bottom: 25px;
          font-size: 24px;
          color: #333;
        }

        label {
          display: block;
          margin: 15px 0 5px;
          text-align: left;
          font-weight: 500;
          color: #444;
          font-size: 14px;
        }

        select, input {
          width: 100%;
          padding: 12px;
          margin-bottom: 12px;
          border: 1px solid #ccc;
          border-radius: 8px;
          font-size: 14px;
          outline: none;
          transition: 0.2s;
        }

        select:focus, input:focus {
          border-color: #6a11cb;
          box-shadow: 0 0 6px rgba(106, 17, 203, 0.3);
        }

        button {
          background: linear-gradient(135deg, #6a11cb, #2575fc);
          color: white;
          padding: 14px;
          border: none;
          border-radius: 10px;
          width: 100%;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          margin-top: 10px;
          transition: transform 0.2s ease, background 0.3s ease;
        }

        button:hover {
          transform: scale(1.03);
          background: linear-gradient(135deg, #5a0eb5, #1e63d6);
        }

        #toggle-link {
          cursor: pointer;
          color: #2575fc;
          margin-top: 15px;
          font-size: 14px;
          display: inline-block;
          transition: color 0.3s;
        }

        #toggle-link:hover {
          color: #6a11cb;
          text-decoration: underline;
        }

        #response {
          margin-top: 15px;
          color: red;
          font-weight: bold;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
<div class="login-box">
    <h2 id="form-title">User Login</h2>

    <label>Role:</label>
    <select id="role" required>
        <option value="STUDENT">Student</option>
        <option value="MENTOR">Mentor</option>
    </select>

    <label>Username:</label>
    <input type="text" id="USN" placeholder="Enter USN" required>

    <label id="email-label">Email:</label>
    <input type="email" id="email" placeholder="Enter email address" required>

    <label>Password:</label>
    <input type="password" id="password" placeholder="Enter password" required>

    <label id="confirm-password-label" style="display:none;">Confirm Password:</label>
    <input type="password" id="confirm-password" placeholder="Confirm password" style="display:none;">


    <button onclick="submitForm()" id="submitBtn">Login</button>

    <p id="toggle-link">Don't have an account? Sign Up</p>
    <p id="response"></p>
</div>

<script>
    let isLogin = true;
    const USNInput = document.getElementById("USN");
    const emailInput = document.getElementById("email"); // New email input reference
    const roleInput = document.getElementById("role");
    const passwordInput = document.getElementById("password");
    const confirmPasswordInput = document.getElementById("confirm-password");
    const confirmPasswordLabel = document.getElementById("confirm-password-label");
    const formTitle = document.getElementById("form-title");
    const submitBtn = document.getElementById("submitBtn");
    const toggleLink = document.getElementById("toggle-link");
    const responseText = document.getElementById("response");
    const emailLabel = document.getElementById("email-label"); // New email label reference

    document.getElementById("toggle-link").addEventListener("click", () => {
      isLogin = !isLogin;
      formTitle.innerText = isLogin ? "User Login" : "User Sign Up";
      submitBtn.innerText = isLogin ? "Login" : "Sign Up";
      toggleLink.innerText = isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
      responseText.innerText = ""; // Clear any previous error messages

      // Toggle visibility of Confirm Password and Email fields
      if (isLogin) {
        confirmPasswordLabel.style.display = 'none';
        confirmPasswordInput.style.display = 'none';
        confirmPasswordInput.value = ''; // Clear the field

        // Hide email field in Login (if you only want it for Sign Up)
        emailLabel.style.display = 'none';
        emailInput.style.display = 'none';
      } else {
        confirmPasswordLabel.style.display = 'block';
        confirmPasswordInput.style.display = 'block';

        // Show email field in Sign Up
        emailLabel.style.display = 'block';
        emailInput.style.display = 'block';
      }
    });

    async function submitForm() {
      const username = USNInput.value.trim();
      const password = passwordInput.value;
      const role = roleInput.value;
      const email = emailInput.value.trim(); // Get email value
      const endpoint = isLogin ? "/api/auth/login" : "/api/auth/signup";
      responseText.innerText = ""; // Clear previous response

      // --- Client-Side Validation for Sign Up ---
      if (!isLogin) {
        const confirmPassword = confirmPasswordInput.value;

        // 1. Check USN Length (must be 10)
        if (username.length !== 10) {
          responseText.innerText = "Error: USN must be exactly 10 characters long.";
          return;
        }

        // 2. Check Password Match
        if (password !== confirmPassword) {
          responseText.innerText = "Error: Password and Confirm Password do not match.";
          return;
        }
      }
      // --- End Client-Side Validation ---

      // Prepare data payload
      const payload = { username, password, role };

      if (!isLogin) {
          // Only include confirmPassword and email in the payload for signup
          payload.confirmPassword = confirmPasswordInput.value;
          payload.email = email; // Include email for signup
      }

      try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams(payload)
          });

          if (res.ok) {
            if (isLogin) {
              localStorage.setItem("username", username);
              localStorage.setItem("role", role);
              alert("Login successful!");
              if (role === "STUDENT") {
                window.location.href = "student_dashboard.html";
              } else {
                window.location.href = "mentor_dashboard.html";
              }
            } else {
              alert("Sign up successful! Please login.");
              // **CHANGE 1: Refresh the login page after sign up**
              window.location.reload();
            }
          } else {
            responseText.innerText = await res.text();
          }
      } catch (error) {
          responseText.innerText = "An unexpected error occurred. Please try again.";
          console.error('Fetch error:', error);
      }
    }
</script>
</body>
</html>
