<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mentor Dashboard</title>
    <style>
        :root{
          --bg:#f4f7fb;
          --card:#ffffff;
          --accent:#1976d2;
          --muted:#6b7280;
          --radius:10px;
        }
        *{box-sizing:border-box}
        body{
          margin:0;
          font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
          background:var(--bg);
          color:#0f172a;
        }
        .topbar{
          height:64px;
          display:flex;
          align-items:center;
          justify-content:space-between;
          padding:10px 20px;
          background:linear-gradient(90deg,var(--card),transparent);
          border-bottom:1px solid rgba(15,23,42,0.04);
        }
        .brand{display:flex;align-items:center;gap:12px}
        .logo{
          width:44px;height:44px;border-radius:8px;background:var(--accent);
          display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
        }
        .title{font-size:18px;font-weight:600}
        .muted{color:var(--muted);font-size:13px}

        .container{max-width:1100px;margin:18px auto;padding:20px;display:flex;flex-direction:column;gap:18px}

        .header{
          display:flex;align-items:center;justify-content:space-between;gap:12px;
        }
        .profile{
          display:flex;align-items:center;gap:12px;
        }
        .avatar{width:56px;height:56px;border-radius:12px;background:#e6f0fb;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:700;font-size:18px}
        .grid{
          display:grid;
          grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
          gap:16px;
        }
        .card{
          background:var(--card);
          border-radius:var(--radius);
          padding:18px;
          box-shadow:0 8px 28px rgba(11,20,40,0.06);
          display:flex;flex-direction:column;gap:10px;
        }
        .card .title{font-size:16px;font-weight:700}
        .card .desc{color:var(--muted);font-size:13px}
        .card .actions{display:flex;gap:8px;margin-top:8px}
        .btn{
          padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600;background:var(--accent);color:white;
        }
        .link{
          text-decoration:none;color:var(--accent);font-weight:700;padding:8px;border-radius:8px;border:1px solid rgba(25,118,210,0.08)
        }

        .notif{
          background:linear-gradient(90deg,rgba(25,118,210,0.04),transparent);
          border-radius:10px;padding:12px;border:1px solid rgba(15,23,42,0.04)
        }
        @media(max-width:680px){
          .header{flex-direction:column;align-items:flex-start;gap:8px}
        }
    </style>
</head>
<body>
<div class="topbar">
    <div class="brand">
        <div class="logo">MT</div>
        <div>
            <div class="title">Mentor Portal</div>
            <div class="muted" style="font-size:12px">Validate & Approve Student Data</div>
        </div>
    </div>

    <div style="display:flex;align-items:center;gap:12px">
        <div class="muted">Mentor: <span id="mentorName">â€”</span></div>
        <button id="logoutBtn" onclick="logout()" style="padding:8px 12px;border-radius:8px;border:0;background:#ef4444;color:white;cursor:pointer">Logout</button>
    </div>
</div>

<div class="container">
    <div class="header">
        <div style="display:flex;gap:12px;align-items:center">
            <!-- Mentor initials (auto-filled from JS) -->
            <div class="avatar" id="mentorShort">--</div>

            <div>
                <!-- Mentor full name (auto-filled from JS) -->
                <div id="mentorFullName" style="font-weight:700">Loading...</div>
                <!-- Mentor email, USN, department (auto-filled from JS) -->
                <div class="muted" id="mentorMeta">Loading...</div>
            </div>
        </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
            <div class="notif" id="notifications">
                <div style="font-weight:700">Notifications</div>
                <div class="muted" id="notifText" style="margin-top:6px">No new notifications</div>
            </div>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <div class="title">Filter Students</div>
            <div class="desc">View your mentees, filter by year, department, or submission status.</div>
            <div class="actions">
                <a class="link" href="/mentor/filter">Open</a>
            </div>
        </div>

        <div class="card">
            <div class="title">Validate Marks & Activities</div>
            <div class="desc">Review pending uploads from students. Approve to lock or send back for correction.</div>
            <div class="actions">
               <a class="link" href="mentor_validate.html">Review</a>
            </div>
        </div>

        <div class="card">
            <div class="title">Monitor Platform</div>
            <div class="desc">Usage stats and platform health. See which students haven't completed setup.</div>
            <div class="actions">
                <a class="link" href="/mentor/monitor">Open</a>
            </div>
        </div>

        <div class="card">
            <div class="title">My Mentees</div>
            <div class="desc">Quick list of your linked students (auto-linked by Mentor ID). Click to view student profiles.</div>
            <div class="actions">
                <<a class="link" href="my_mentees.html">View</a>
            </div>
        </div>
    </div>

    <div style="display:flex;gap:16px;margin-top:12px;flex-wrap:wrap">
        <div class="card" style="flex:1;min-width:320px">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-weight:700">Pending Validations</div>
                    <div class="muted">Students waiting for approval</div>
                </div>
                <button class="btn" onclick="openValidations()">Open</button>
            </div>
            <div style="margin-top:8px" id="pendingList">Loading...</div>
        </div>

        <div class="card" style="width:280px;">
            <div style="font-weight:700">Quick Actions</div>
            <div class="desc" style="margin-top:8px">Common actions for mentors</div>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
                <button class="btn" onclick="validateAll()">Validate All</button>
                <button class="btn" style="background:#0ea5e9" onclick="messageAll()">Message Mentees</button>
            </div>
        </div>
    </div>
</div>

<script>
    // safe HTML escape helper
    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

   async function fetchUser() {
  const res = await fetch('/api/mentor/me'); // âœ… correct endpoint
  if (!res.ok) {
    window.location = "index.html";
    return;
  }

  const user = await res.json();

  // Redirect if department missing
   if (!user.department || user.department.trim() === "") {
    window.location = "mentor_setup.html";
    return;
  }

  // Mentor initials (first letters of name or username)
  const initials = (user.name || user.username || "??")
      .split(" ")
      .map(word => word[0])
      .join("")
      .substring(0, 2)
      .toUpperCase();
  document.getElementById("mentorShort").textContent = initials;

  // Full name (fallback to username if name missing)
  document.getElementById("mentorFullName").textContent = user.name || user.username;

  // Meta info: email + USN + department
  document.getElementById("mentorMeta").textContent =
    `Email: ${user.email || "N/A"} â€¢ USN: ${user.usn || "N/A"} â€¢ Department: ${user.department || "N/A"}`;
}
   
   ////////Notification Logic 
   async function loadPendingCertificates() {
	  const res = await fetch('/api/mentor/certificates/pending', {
	    credentials: 'include'   // ðŸ”´ REQUIRED
	  });
	
	  if (!res.ok) return;
	
	  const certs = await res.json();
	
	  const notif = document.getElementById("notifText");
	  const list = document.getElementById("pendingList");
	
	  if (certs.length === 0) {
	    notif.textContent = "No new notifications";
	    list.textContent = "No pending validations";
	    return;
	  }
	
	  notif.textContent = certs.length + " certificate(s) pending approval";
	
	  list.innerHTML = certs.map(c =>
	    `<div>${c.studentUsn} - ${c.certificateType}</div>`
	  ).join("");
	}

	/////



    // call on load
    fetchUser();
    loadPendingCertificates();

    // logout (POST is common but adjust to your backend)
    async function logout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      } catch (err) {
        console.warn('Logout request failed, redirecting anyway.', err);
      } finally {
        window.location.href = 'index.html';
      }
    }

    // Placeholder helpers for buttons â€” replace with real implementations
    function openValidations() {
    	window.location.href = 'mentor_validate.html';
    }
    function validateAll() {
      if (confirm('Validate all pending items?')) {
        // replace with real API call if needed
        alert('All pending items validated (demo).');
      }
    }
    function messageAll() {
      // open messaging page or trigger API
      window.location.href = '/mentor/messages';
    }
</script>
</body>
</html>
